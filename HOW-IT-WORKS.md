# 腳本運作說明

## 啟動流程

```
 ┌─────────────┐
 │  npm start  │  或  npm run check
 └──────┬──────┘
        ▼
 ┌─────────────┐
 │ 讀取 .env   │
 └──────┬──────┘
        ▼
 ┌──────────────────────┐    ╔══════════════════╗
 │ TOKEN & USER_ID 存在?│─NO─║ 印錯誤訊息並結束 ║
 └──────┬───────────────┘    ╚══════════════════╝
       YES
        ▼
 ┌──────────────────┐
 │ 判斷執行模式     │
 ├──────────────────┤
 │ --once?          │
 └──┬───────────┬───┘
   YES          NO
    ▼            ▼
 檢查一次     ┌──────────────────────┐
 然後結束     │ 立即檢查一次         │
              │ + 啟動 cron 定時排程 │
              │ （Ctrl+C 停止）      │
              └──────────┬───────────┘
                         ▼
                  每隔 N 分鐘重複 ──┐
                         ▲          │
                         └──────────┘
```

## 每次檢查的流程

```
 ┌──────────────────────────┐
 │ 1. 抓取 tixplus 網頁     │
 └────────────┬─────────────┘
              ▼
 ┌──────────────────────────┐    ┌──────────────┐
 │ 2. 解析 data-page JSON   │─X─▶│ 印警告，結束 │
 └────────────┬─────────────┘    └──────────────┘
              ▼
 ┌──────────────────────────────┐
 │ 3. 篩選刊登數 ≥ MIN_LISTINGS │
 └────────────┬─────────────────┘
              ▼
 ┌──────────────────────────────┐
 │ 4. 讀取 .notify-state.json   │
 │    比對上次通知的狀態         │
 └────────────┬─────────────────┘
              ▼
 ┌────────────────────┐
 │ 有新賽事/刊登增加?  │
 └──┬─────────────┬───┘
   YES            NO
    ▼              ▼
 ┌────────────┐  ┌─────────────────────┐
 │ 發 LINE 通知│  │ 印「沒有新的變動」   │
 └─────┬──────┘  └─────────────────────┘
       ▼
 ┌──────────────────────────┐
 │ 5. 更新 .notify-state.json│
 └──────────────────────────┘
```

## 兩種執行模式

| 指令 | 模式 | 何時結束 | 用途 |
|------|------|----------|------|
| `npm run check` | 單次 | 跑完自動結束 | 測試設定、手動檢查 |
| `npm start` | 持續監控 | `Ctrl+C` 手動停止 | 長期掛著自動通知 |

## 狀態追蹤邏輯

腳本用 `.notify-state.json` 記錄上次通知的賽事狀態，避免重複推播：

| 情境 | 動作 |
|------|------|
| 首次執行（無狀態檔） | 全部通知，建立狀態檔 |
| 賽事資料沒變 | 跳過，印「沒有新的變動」 |
| 新賽事出現 | 通知 |
| 刊登數增加 | 通知 |
| 刊登數減少或不變 | 跳過 |
| 賽事消失（低於門檻） | 從狀態檔移除，再出現時視為新賽事重新通知 |
| 狀態檔損壞 | 自動重建，全部重新通知 |

> 想重置狀態讓所有賽事重新通知？刪除 `.notify-state.json` 即可。

## 檔案結構

```
tixplus-wbc-notify/
├── tixplus-wbc-notify.js   # 主程式
├── package.json
├── setup.sh                # 互動式設定（可重複執行更新設定）
├── .env                    # 你的設定（不進 git）
├── .env.example            # 設定範本
├── .notify-state.json      # 狀態檔（自動產生，不進 git）
└── .gitignore
```
